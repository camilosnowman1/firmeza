@model Firmeza.Web.Models.SaleViewModel
@using System.Text.Json;

@{ ViewData["Title"] = "Create Sale"; }

<h2>Create a New Sale</h2>
<hr />

<form asp-action="Create">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="CustomerId" class="control-label">Customer</label>
                <select asp-for="CustomerId" class="form-control" asp-items="Model.Customers"></select>
            </div>
        </div>
    </div>

    <h4 class="mt-4">Sale Items</h4>
    <div id="items-container">
        <!-- Items will be added here by JavaScript -->
    </div>

    <div class="row mt-3">
        <div class="col-md-5">
            <select id="product-selector" class="form-control" asp-items="Model.Products"></select>
        </div>
        <div class="col-md-2">
            <input id="quantity-input" type="number" class="form-control" value="1" min="1" />
        </div>
        <div class="col-md-3">
            <button type="button" id="add-item-btn" class="btn btn-info">Add Product</button>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-10 text-right">
            <h4>Total: <span id="total-amount">$0.00</span></h4>
        </div>
    </div>

    <div class="form-group mt-4">
        <input type="submit" value="Create Sale" class="btn btn-primary" />
        <a asp-action="Index" class="btn btn-secondary">Back to List</a>
    </div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const addItemBtn = document.getElementById('add-item-btn');
            const itemsContainer = document.getElementById('items-container');
            const productSelector = document.getElementById('product-selector');
            const quantityInput = document.getElementById('quantity-input');
            const totalAmountSpan = document.getElementById('total-amount');
            
            const productPrices = @Html.Raw(JsonSerializer.Serialize(Model.ProductPrices));
            let itemIndex = 0;

            function updateTotals() {
                let total = 0;
                document.querySelectorAll('.item-row').forEach(row => {
                    const productId = row.querySelector('input[name$=".ProductId"]').value;
                    const quantity = row.querySelector('input[name$=".Quantity"]').value;
                    const price = productPrices[productId];
                    if (price) {
                        total += quantity * price;
                    }
                });
                totalAmountSpan.textContent = `$${total.toFixed(2)}`;
            }

            addItemBtn.addEventListener('click', function () {
                const productId = productSelector.value;
                const productName = productSelector.options[productSelector.selectedIndex].text;
                const quantity = quantityInput.value;

                if (!productId || !quantity || quantity < 1) {
                    alert('Please select a product and enter a valid quantity.');
                    return;
                }

                const itemHtml = `
                    <div class="row mb-2 item-row">
                        <div class="col-md-5">${productName}</div>
                        <div class="col-md-2">Qty: ${quantity}</div>
                        <div class="col-md-3">
                            <input type="hidden" name="Items[${itemIndex}].ProductId" value="${productId}" />
                            <input type="hidden" name="Items[${itemIndex}].Quantity" value="${quantity}" />
                            <button type="button" class="btn btn-danger btn-sm remove-item-btn">Remove</button>
                        </div>
                    </div>`;
                
                itemsContainer.insertAdjacentHTML('beforeend', itemHtml);
                itemIndex++;
                updateTotals();
            });

            itemsContainer.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('remove-item-btn')) {
                    e.target.closest('.item-row').remove();
                    updateTotals();
                }
            });
        });
    </script>
}
