@model Firmeza.Web.Controllers.SaleViewModel

@{ ViewData["Title"] = "Create Sale"; }

<h1>@ViewData["Title"]</h1>
<hr />

<form asp-action="Create" method="post">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label asp-for="CustomerId" class="control-label">Customer</label>
                <select asp-for="CustomerId" class="form-control" asp-items="Model.Customers">
                    <option value="">-- Select a Customer --</option>
                </select>
                <span asp-validation-for="CustomerId" class="text-danger"></span>
            </div>
        </div>
    </div>

    <hr />
    
    <h4>Add Products to Sale</h4>
    <div class="row align-items-end">
        <div class="col-md-5">
            <label for="product-select">Product</label>
            <select id="product-select" class="form-control" asp-items="Model.Products">
                 <option value="">-- Select a Product --</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="product-quantity">Quantity</label>
            <input type="number" id="product-quantity" class="form-control" value="1" min="1" />
        </div>
        <div class="col-md-2">
            <button type="button" id="add-product-btn" class="btn btn-info">Add Product</button>
        </div>
    </div>

    <hr />

    <h4>Sale Items</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="sale-items-tbody">
            <!-- Items will be added here by JavaScript -->
        </tbody>
    </table>

    <div class="form-group mt-4">
        <input type="submit" value="Create Sale" class="btn btn-primary" />
        <a asp-action="Index" class="btn btn-secondary">Back to List</a>
    </div>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            let itemIndex = 0;

            $('#add-product-btn').on('click', function () {
                const productId = $('#product-select').val();
                const productName = $('#product-select option:selected').text();
                const quantity = $('#product-quantity').val();

                if (!productId || !quantity || quantity <= 0) {
                    alert("Please select a product and enter a valid quantity.");
                    return;
                }

                // Add item to the table
                $('#sale-items-tbody').append(`
                    <tr data-id="${itemIndex}">
                        <td>${productName}</td>
                        <td>${quantity}</td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
                    </tr>
                `);

                // Add hidden inputs for model binding
                $('form').append(`<input type="hidden" name="Items[${itemIndex}].ProductId" value="${productId}" />`);
                $('form').append(`<input type="hidden" name="Items[${itemIndex}].Quantity" value="${quantity}" />`);
                
                itemIndex++;
                
                // Clear inputs
                $('#product-select').val('');
                $('#product-quantity').val(1);
            });

            // Remove item
            $(document).on('click', '.remove-item', function () {
                const rowIndex = $(this).closest('tr').data('id');
                $(this).closest('tr').remove();
                $(`input[name^='Items[${rowIndex}]']`).remove();
            });
        });
    </script>
}